@model List<ShoppingCartApp.Models.CartItem>
@{
    ViewData["Title"] = "Your Cart";
}

<h2>Your Cart</h2>
@if (!Model.Any())
{
    <p>No items in cart.</p>
}
else
{
    <table class="table table-hover table-bordered">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th style="width:150px;">Quantity</th>
                <th>Price</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-product-id="@item.ProductId">
                    <td>@item.Name</td>
                    <td>
                        
                        <input type="number" name="quantity" value="@item.Quantity" min="1"
                               class="form-control form-control-sm quantity-input" style="width:70px" />
                    </td>
                    <td>@item.Price $</td>
                    <td class="item-total">@(item.Price * item.Quantity)$</td>
                    <td>
                        <a asp-action="RemoveFromCart" asp-route-id="@item.ProductId" class="btn btn-sm btn-danger">Remove</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h4 class="text-end">Total: <span id="cart-total">@Model.Sum(i => i.Price * i.Quantity)$</span></h4>

    <div class="d-flex justify-content-end gap-2">

        <a asp-controller="Payment" asp-action="Checkout" class="btn btn-success">Continue to Payment</a>
        <a asp-action="ClearCart" class="btn btn-danger">Clear Cart</a>
    </div>
    <a href="javascript:history.back()" class="btn btn-secondary mb-3">Back</a>

}

@section Scripts {
    <script>
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function () {
                const tr = this.closest('tr');
                const productId = tr.getAttribute('data-product-id');
                const quantity = this.value;

                fetch('/Cart/UpdateQuantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `productId=${productId}&quantity=${quantity}`
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            
                            tr.querySelector('.item-total').textContent = data.totalItem + '$';
                            document.getElementById('cart-total').textContent = data.totalCart + '$';
                        }
                    });
            });
        });
    </script>
}
